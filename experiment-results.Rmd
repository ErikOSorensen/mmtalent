---
title: "Experiment outcomes"
author: "Erik Ø. Sørensen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(targets)
require(tidyverse)
require(gt)
require(patchwork)
tar_load(mmtalent)
```


# Histogram of distributions
```{r Dollars redistributed, echo=FALSE}
tar_load(histogram_distribution_graph)
histogram_distribution_graph
ggsave(here::here("figures","histogram_transfers.pdf"), width = 16, height = 10, units = "cm")
```


# Graph with average outcomes
```{r Mean Gini implemented by treatments, echo=FALSE}
tar_load(average_distributions_graph)
average_distributions_graph$graph
ggsave(here::here("figures","average_ginis.pdf"), width = 16, height = 10, units = "cm")
```
Means broken down by timing:

```{r means broken down by timing, echo=FALSE}
mmtalent |> group_by(timing) |> summarize(meanGINI = weighted.mean(gini, weights=wgt),
                                          share_nothingtw = weighted.mean( nothingtw, weights=wgt)) 

mmtalent |> lm(gini ~ timing, data=_, weights=wgt) |> summary() 
mmtalent |> lm(nothingtw ~ timing, data=_, weights=wgt) |> summary()
```




Means broken down by personal.
```{r means broken down by personal, echo=FALSE}
mmtalent |> group_by(personal) |> summarize(meanGINI = weighted.mean(gini, weights=wgt),
                                          share_nothingtw = weighted.mean( nothingtw, weights=wgt))
mmtalent |> lm(gini ~ personal, data=_, weights=wgt) |> summary() 
mmtalent |> lm(nothingtw ~ personal, data=_, weights=wgt) |> summary()
```

```{r}
mmtalent |> lm(gini ~ timing*personal, weights=wgt, data=_) |>summary()
mmtalent |> lm(nothingtw ~ timing*personal, weights=wgt, data=_) |>summary()


```


Testing 


# Regressions

We look at two different outcomes. The first is the gini coefficient, which (as before) is between 0 and 0.6 (there is a
base income of (2,2) that cannot be lowered, so max inequality is (8,2) or (2,8)). 
The second outcome is a dummy indicator for maximum inequality (or giving nothing to the 
worst off, "nothingtw" in the table below). 


```{r Label mappings (main), include=FALSE}
outcome_names <- c('treatmentExAntePersonal' = 'Ex Ante Personal (d)',
                   'treatmentExAnteImpersonal' = 'Ex Ante Impersonal (d)',
                   'treatmentExPostPersonal' = 'Ex Post Personal (d)',
                  'age' = 'Age (years)',
                  'age_high' = 'High age (d)',
                  'leftTRUE' = 'Left (d)',
                  'high_incomeTRUE' = 'High income (d)',
                  'high_eduTRUE' = 'High education (d)',
                  'maleTRUE' = 'Male (d)',
                  '(Intercept)'='(Intercept)')
```



```{r Implemented Inequality regressed on treatments, echo=FALSE}
tar_load(implemented_inequality_list)
reg1 <- modelsummary::modelsummary(implemented_inequality_list,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           coef_map = outcome_names,
                           output = "gt",
                           gof_omit = "R2 Adj.|se_type|AIC|BIC|Log.Lik.|F") |>
  tab_spanner(label="Gini", columns=2:3) |> 
  tab_spanner(label="Nothing to worst of", columns = 4:5) |>
  tab_spanner(label="No redistribution", columns=6:7)
reg1
reg1 |> as_latex() |>
  cat(file=here::here("tables","inequality_treatment_regression.tex"))
```

Testing interaction effects:
```{r}
car::linearHypothesis(implemented_inequality_list[[2]], c("treatmentExAntePersonal - treatmentExAnteImpersonal - treatmentExPostPersonal = 0"))
car::linearHypothesis(implemented_inequality_list[[4]], c("treatmentExAntePersonal - treatmentExAnteImpersonal - treatmentExPostPersonal = 0"))
car::linearHypothesis(implemented_inequality_list[[6]], c("treatmentExAntePersonal - treatmentExAnteImpersonal - treatmentExPostPersonal = 0"))

```


## Heterogeneity in treatment outcomefs

Needs a new list of labels

```{r Label mappings (heterogeneity table), include=FALSE}
outcome_names_het1 <- c('timingExAnte' = 'Ex Ante (d)',
                   'timingExAnte:age_high' = "Ex Ante X High age",
                   'timingExAnte:leftTRUE' = "Ex Ante X Left",
                   'timingExAnte:high_eduTRUE' = "Ex Ante X High education",
                   'timingExAnte:high_incomeTRUE' = "Ex Ante X High income",
                   'timingExAnte:maleTRUE' = "Ex Ante X male",
                   'personTRUE' = 'Personal (d)',
                   'personTRUE:age_high' = "Personal X High age",
                   'personTRUE:leftTRUE' = "Personal X Left",
                   'personTRUE:high_eduTRUE' = "Personal X High education",
                   'personTRUE:high_incomeTRUE' = "Personal X High income",
                   'personTRUE:maleTRUE' = "Personal X male",
                  'age_high' = 'High age (d)',
                  'leftTRUE' = 'Left (d)',
                  'high_incomeTRUE' = 'High income (d)',
                  'high_eduTRUE' = 'High education (d)',
                  'maleTRUE' = 'Male (d)',
                  '(Intercept)'='(Intercept)')
```


```{r Heterogeneity in treatment effects on implemented inequality, echo=FALSE}
tar_load(implemented_inequality_heterogeneity_list)
lst3 <- modelsummary::modelsummary(implemented_inequality_heterogeneity_list$All,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           coef_map = outcome_names_het1,
                           output = "gt",
                           gof_omit = "R2 Adj.|se_type|AIC|BIC|Log.Lik.|F|RMSE") |>
  tab_spanner(label="Gini", columns=2:6) |>
  tab_spanner(label="Maximum Inequality", columns=7:11)
lst3
lst3 |> as_latex() |>
  cat(file=here::here("tables","inequality_treatment_regression_het3.tex"))
```

And for personal:

```{r}
lst4 <- modelsummary::modelsummary(implemented_inequality_heterogeneity_list$DAll,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           coef_map = outcome_names_het1,
                           output = "gt",
                           gof_omit = "R2 Adj.|se_type|AIC|BIC|Log.Lik.|F|RMSE") |>
  tab_spanner(label="Gini", columns=2:6) |>
  tab_spanner(label="Maximum Inequality", columns=7:11)
lst4
lst4 |> as_latex() |>
  cat(file=here::here("tables","inequality_treatment_regression_het4.tex"))
```





Presenting heterogeneity in a figure instead:

```{r}
tar_load(inequality_heterogeneity)
L <- inequality_heterogeneity

L$graph1 / L$graph2 + plot_annotation(tag_levels = "a") + plot_layout(nrow=2)
ggsave(here::here("figures","experiment_heterogeneity.pdf"), width = 16, height=14, units="cm")
```


The same heterogeneity figure, but for "personal" (for appendix).

```{r}
L$graph3 / L$graph4 + plot_annotation(tag_levels = "a") + plot_layout(nrow=2)
ggsave(here::here("figures","experiment_heterogeneity_personal.pdf"), width = 16, height=14, units="cm")
```
