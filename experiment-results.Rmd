---
title: "Experiment outcomes"
author: "Erik Ø. Sørensen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(targets)
require(tidyverse)
require(gt)
require(patchwork)
tar_load(mmtalent)
```


# Histogram of distributions
```{r Dollars redistributed, echo=FALSE}
tar_load(histogram_distribution_graph)
histogram_distribution_graph
ggsave(here::here("figures","histogram_transfers.pdf"), width = 16, height = 10, units = "cm")
```


# Graph with average outcomes
```{r Mean Gini implemented by treatments, echo=FALSE}
tar_load(average_distributions_graph)
average_distributions_graph$graph
ggsave(here::here("figures","average_ginis.pdf"), width = 16, height = 10, units = "cm")
```
Means broken down by timing:

```{r means broken down by timing, echo=FALSE}
mmtalent |> group_by(timing) |> summarize(meanGINI = weighted.mean(gini, weights=wgt),
                                          share_nothingtw = weighted.mean( nothingtw, weights=wgt)) 

mmtalent |> lm(gini ~ timing, data=_, weights=wgt) |> summary() 
mmtalent |> lm(nothingtw ~ timing, data=_, weights=wgt) |> summary()
```




Means broken down by personal.
```{r means broken down by personal, echo=FALSE}
mmtalent |> group_by(personal) |> summarize(meanGINI = weighted.mean(gini, weights=wgt),
                                          share_nothingtw = weighted.mean( nothingtw, weights=wgt))
mmtalent |> lm(gini ~ personal, data=_, weights=wgt) |> summary() 
mmtalent |> lm(nothingtw ~ personal, data=_, weights=wgt) |> summary()
```

```{r}
mmtalent |> lm(gini ~ timing*personal, weights=wgt, data=_) |>summary()
mmtalent |> lm(nothingtw ~ timing*personal, weights=wgt, data=_) |>summary()


```


Testing 


# Regressions

We look at two different outcomes. The first is the gini coefficient, which (as before) is between 0 and 0.6 (there is a
base income of (2,2) that cannot be lowered, so max inequality is (8,2) or (2,8)). 
The second outcome is a dummy indicator for maximum inequality (or giving nothing to the 
worst off, "nothingtw" in the table below). 


```{r Label mappings (main), include=FALSE}
outcome_names <- c('treatmentExAntePersonal' = 'Ex Ante Personal (d)',
                   'treatmentExAnteImpersonal' = 'Ex Ante Impersonal (d)',
                   'treatmentExPostPersonal' = 'Ex Post Personal (d)',
                  'age' = 'Age (years)',
                  'age_high' = 'High age (d)',
                  'leftTRUE' = 'Left (d)',
                  'high_incomeTRUE' = 'High income (d)',
                  'high_eduTRUE' = 'High education (d)',
                  'maleTRUE' = 'Male (d)',
                  '(Intercept)'='(Intercept)')
```



```{r Implemented Inequality regressed on treatments, echo=FALSE}
tar_load(implemented_inequality_list)
reg1 <- modelsummary::modelsummary(implemented_inequality_list,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           coef_map = outcome_names,
                           output = "gt",
                           gof_omit = "R2 Adj.|se_type|AIC|BIC|Log.Lik.|F") |>
  tab_spanner(label="Gini", columns=2:3) |> 
  tab_spanner(label="Nothing to worst of", columns = 4:5) |>
  tab_spanner(label="No redistribution", columns=6:7)
reg1
reg1 |> as_latex() |>
  cat(file=here::here("tables","inequality_treatment_regression.tex"))
```

Testing interaction effects:
```{r}
car::linearHypothesis(implemented_inequality_list[[2]], c("treatmentExAntePersonal - treatmentExAnteImpersonal - treatmentExPostPersonal = 0"))
car::linearHypothesis(implemented_inequality_list[[4]], c("treatmentExAntePersonal - treatmentExAnteImpersonal - treatmentExPostPersonal = 0"))
car::linearHypothesis(implemented_inequality_list[[6]], c("treatmentExAntePersonal - treatmentExAnteImpersonal - treatmentExPostPersonal = 0"))

```


## Heterogeneity in treatment outcomefs

Needs a new list of labels

```{r Label mappings (heterogeneity table), include=FALSE}
outcome_names_het1 <- c('timingExAnte' = 'Ex Ante (d)',
                   'timingExAnte:age_high' = "Ex Ante X High age",
                   'timingExAnte:leftTRUE' = "Ex Ante X Left",
                   'timingExAnte:high_eduTRUE' = "Ex Ante X High education",
                   'timingExAnte:high_incomeTRUE' = "Ex Ante X High income",
                   'timingExAnte:maleTRUE' = "Ex Ante X male",
                   'personTRUE' = 'Personal (d)',
                   'personTRUE:age_high' = "Personal X High age",
                   'personTRUE:leftTRUE' = "Personal X Left",
                   'personTRUE:high_eduTRUE' = "Personal X High education",
                   'personTRUE:high_incomeTRUE' = "Personal X High income",
                   'personTRUE:maleTRUE' = "Personal X male",
                  'age_high' = 'High age (d)',
                  'leftTRUE' = 'Left (d)',
                  'high_incomeTRUE' = 'High income (d)',
                  'high_eduTRUE' = 'High education (d)',
                  'maleTRUE' = 'Male (d)',
                  '(Intercept)'='(Intercept)')
```


```{r Heterogeneity in treatment effects on implemented inequality, echo=FALSE}
tar_load(implemented_inequality_heterogeneity_list)
lst3 <- modelsummary::modelsummary(implemented_inequality_heterogeneity_list$All,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           coef_map = outcome_names_het1,
                           output = "gt",
                           gof_omit = "R2 Adj.|se_type|AIC|BIC|Log.Lik.|F|RMSE") |>
  tab_spanner(label="Gini", columns=2:6) |>
  tab_spanner(label="Maximum Inequality", columns=7:11)
lst3
lst3 |> as_latex() |>
  cat(file=here::here("tables","inequality_treatment_regression_het3.tex"))
```

And for personal:

```{r}
lst4 <- modelsummary::modelsummary(implemented_inequality_heterogeneity_list$DAll,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           coef_map = outcome_names_het1,
                           output = "gt",
                           gof_omit = "R2 Adj.|se_type|AIC|BIC|Log.Lik.|F|RMSE") |>
  tab_spanner(label="Gini", columns=2:6) |>
  tab_spanner(label="Maximum Inequality", columns=7:11)
lst4
lst4 |> as_latex() |>
  cat(file=here::here("tables","inequality_treatment_regression_het4.tex"))
```





Presenting heterogeneity in a figure instead:

```{r Heterogeneity in the treatment effect, echo=FALSE}
tar_load(inequality_heterogeneity)
L <- inequality_heterogeneity

L$graph1 / L$graph2 + plot_annotation(tag_levels = "a") + plot_layout(nrow=2)
ggsave(here::here("figures","experiment_heterogeneity.pdf"), width = 16, height=14, units="cm")
```


The same heterogeneity figure, but for "personal" (for appendix).

```{r}
L$graph3 / L$graph4 + plot_annotation(tag_levels = "a") + plot_layout(nrow=2)
ggsave(here::here("figures","experiment_heterogeneity_personal.pdf"), width = 16, height=14, units="cm")
```


# Request by referee
A referee wants more details, effects on each level of transfer 
I propose a solution in which the outcome is the amount given to the disadvantaged,
and it varies from no redistribution ($Y=2$), to complete reversal ($Y=8$).


```{r Decision amounts, echo=FALSE, message=FALSE, warning=FALSE}
tar_load(decision_amount)

dreg <- modelsummary::modelsummary(decision_amount,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           coef_map = outcome_names,
                           output = "gt",
                           gof_omit = "R2 Adj.|se_type|AIC|BIC|Log.Lik.|F|RMSE") |>
  tab_spanner(label="Yb=2", columns=2) |> 
  tab_spanner(label="Yb=3", columns=3) |> 
  tab_spanner(label="Yb=4", columns=4) |> 
  tab_spanner(label="Yb=5", columns=5) |> 
  tab_spanner(label="Yb=6", columns=6) |> 
  tab_spanner(label="Yb=7", columns=7) |> 
  tab_spanner(label="Yb=8", columns=8) |>
  tab_spanner(label="A is favored", columns=2:4) |> 
  tab_spanner(label="Equality", columns=5) |> 
  tab_spanner(label="B is favored", columns=6:8)
dreg
dreg |> as_latex() |>
  cat(file=here::here("tables","decision_amount_regression.tex"))
```


We compare the transfers in our experiment with those in the *“Cuddly Socialism”* study
(Almås et al., *Journal of Political Economy*, 2020). The most comparable treatments are
the **Luck** treatment in Almås et al., which corresponds most closely to the  **Ex Post Impersonal** treatment in the current study.
The range of possible allocations differs slightly across the two settings.  In our study, allocations range from **(8, 2)** to **(2, 8)**, while in the
Almås et al. study the range is **(6, 0)** to **(0, 6)**. Thus, the range of the *transfer* variable is identical across studies.
Because the data from Almås et al. do not include post-stratification weights, we base the comparison on **unweighted** shares.

```{r Cuddly comparisons: graph, echo=FALSE, message=FALSE, warning=FALSE}
tar_load(cuddly_comparisons)
cuddly_comparisons$graph
ggsave(here::here("figures","cuddly_comparisons_graph.pdf"), width=16, height = 10, units="cm")
```

*Note:* For the current study, the figure shows the distribution of transfers in the
**Ex Post Impersonal** treatment. For the Almås et al. (2020) study, it shows the
distribution of transfers in the United States in the **Luck** treatment. 

The estimated proportions are:

```{r Cuddly comparisons: table, echo=FALSE, message=FALSE, warning=FALSE}
cuddly_comparisons$table
```


