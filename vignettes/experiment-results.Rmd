---
title: "experiment-results"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{experiment-results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.width = 7,
  fig.height = 4.5,
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tidyverse)
library(mmtalent)
library(stargazer)
df <- prepare_data(mmtalent_df, populationweights2016)
```

# Histogram of distributions
```{r}
df %>% ggplot(aes(x=payment_low_worker-2,y = (..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]) ) + 
  geom_bar() +
  theme_bw() +
  facet_wrap(. ~ treatment) +
  scale_x_discrete(limits=c(0,1,2,3,4,5,6)) +
  labs(x = "Transfer to loser",
       y = "Fraction")
ggsave(here::here("graphs","histogram_transfers.pdf"))

```


# Graph with average outcomes
```{r}
dtm <- df %>% group_by(treatment) %>% summarize(se_gini = weighted.sd(gini, wgt)/sqrt(n()),
                                         mean_gini = weighted.mean(gini, wgt))
dtm %>% ggplot(aes(x=treatment, y=mean_gini)) + 
  geom_point() + 
  geom_errorbar(aes(ymin=mean_gini - se_gini, ymax=mean_gini + se_gini), width=0.2) + 
  ylab("Mean gini \u00B1 s.e.m.") + xlab("Treatment") + theme_bw()
ggsave(here::here("graphs","average_ginis.pdf"))
```

# Regressions

We look at two different outcomes. The first is the gini coefficient, which (as before) is between 0 and 0.6 (there is a
base income of (2,2) that cannot be lowered, so max inequality is (8,2) or (2,8)). 
The second outcome is a dummy indicator for maximum inequality (or giving nothing to the 
worst off, "nothingtw" in the table below). 


```{r}
R1 <- lm(gini ~ treatment, data = df, weights=wgt)
R2 <- lm(gini ~ treatment + age + left + high_edu + high_income + as.factor(gender), 
         data = df, weights=wgt)
R3 <- lm(nothingtw ~ treatment, data = df, weights=wgt)
R4 <- lm(nothingtw ~ treatment + age + left + high_edu + high_income + as.factor(gender), 
         data = df, weights=wgt)
```

Table:
```{r}
stargazer(R1, R2, R3, R4,
          style="aer", type="text", keep.stat=c("rsq", "n"), 
          out = here::here("tables","inequality_treatment_regression.tex")) 
```


