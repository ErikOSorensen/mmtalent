---
title: "survey-results"
author: "Erik Ø. Sørensen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    toc: true
---

```{r setup}
library(tidyverse)
library(multiwayvcov)
library(here)
library(multcomp)
require(targets)
require(patchwork)
source(here::here("R","utility.R"))
source(here::here("R","data_transforms.R"))
source(here::here("R","survey_functions.R"))
tar_load(mmtalent)
```

# Figures on attitudes and belief
To have the main result on attitudes and belief, we would like to have aggregate patterns 
before going into the individual level data.
```{r}
long_attitudes(mmtalent) %>% survey_bars(numobs = FALSE, ylimits = c(0,8))
ggsave(here::here("figures","attitudes_beliefs.pdf"), width = 16, height =10, units = "cm")
```

And the corresponding histograms:
```{r}
long_attitudes(mmtalent) %>% 
  group_by(outcometype, fo) %>% 
  summarize(weighted.bars(value, wgt)) %>%
  ggplot(aes(x=v, y=proportion)) +
  geom_col() + 
  theme_minimal() +
  labs(x = "Response (on 0-10 scale)") +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6,7,8,9,10)) +
  facet_grid(outcometype ~ fo)
ggsave(here::here("figures","attitude_histograms.pdf"), width = 16, height = 10, units = "cm")
```

# Subgroups
First for the division of all data into binary groups:

```{r}
long_attitudes(mmtalent) %>% 
  survey_bars_by_subgroup() %>% 
  patchwork::wrap_plots() + plot_layout(ncol=2) + plot_annotation(tag_levels = "a")
ggsave(here::here("figures","attitudes_beliefs_by_subgroups.pdf"), width = 30, height = 50, units="cm")
```

Now with all the $2^5$ combinations:

```{r}
long_attitudes(mmtalent) %>% 
  survey_bars_by_subgroup_cross() %>% 
  patchwork::wrap_plots() + plot_layout(ncol=4) + plot_annotation(tag_levels = "1")
ggsave(here::here("figures","attitudes_beliefs_by_subgroups_cross.pdf"), width = 30, height = 50, units="cm")
```


Now, interacting with political position:
```{r}
long_attitudes(mmtalent) %>%
  mutate(left_description = c("Right", "Left")[left+1]) %>%
  group_by(outcometype, left_description, fo, outcome) %>% summarize(m = weighted.mean(value, wgt), se = weighted.sd(value,wgt)/sqrt(n()))  %>%
  ggplot(aes(x=fo, y=m)) +
  geom_bar(stat="identity") + facet_grid(left_description ~ outcometype) + 
  geom_errorbar(aes(ymin=m-se, ymax=m+se), width=0.2) + 
  labs(x=element_blank(), y="Mean outcome \u00B1 s.e.m.") +
  theme_minimal()
ggsave(here::here("figures","attitudes_beliefs_pol.pdf"))
```

# Regression table
We want to put attitudes on the left hand side and try to
explain it by the type of attitude and the perception of control
in the situation.

Now, we need to turn the data around a bit first:
```{r}
tar_load(subjectives_dt)
subjectives_dt %>% sample_n(3) 
```

Now, it should be possible to run the regression 
$$ A_{i,t} = \beta_0 + \beta_1 B_{i,t} + \beta_2 X_i +  \phi_t + \epsilon_{i,t}, $$
where $i$ index the individual, and $t\in\{ \mathrm{effort}, \mathrm{talent}, \mathrm{luck}\}$, 
$A_{i,t}\in[0,10]$ is the fairness attitude, $B_{i,t}\in[0,10]$ is the control belief, 
$X_i$ is a set of individual controls, and $\phi_t$ is a set of fixed effect for each factor.

```{r}
tar_load(survey_regressions_list)
survey_names <- c('Talent'='Talent (d)',
                  'Effort'='Effort (d)',
                   '`Belief about individual control`'='Belief about control (0-10)',
                  'Talent:`Belief about individual control`' = 'Talent x Belief about control',
                  'Effort:`Belief about individual control`' = 'Effort x Belief about control',
                  'age_high' = 'High age (d)',
                  'leftTRUE' = 'Left (d)',
                  'high_incomeTRUE' = 'High income (d)',
                  'high_eduTRUE' = 'High education (d)',
                  'as.factor(gender)male' = 'Male (d)',
                  'treatmentExAntePersonal' = "Treatment: Ex Ante Personal (d)",
                  'treatmentExPostImpersonal'	= "Treatment: Ex Post Impersonal (d)",
                  'treatmentExPostPersonal' = "Treatment: Ex Post Personal (d)",
                  '(Intercept)'='(Intercept)')
```

```{r echo=FALSE}
t1 <- modelsummary::modelsummary(survey_regressions_list$without_treatment,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           gof_omit = "R2 Adj.|se_type",
                           coef_map = survey_names,
                           output = "gt") |>
  tab_spanner(label = "Fairness of Talent,Effort,Luck determining income", columns = 2:6)
t1
t1 |> as_latex() |>
    cat(file=here::here("tables","attitudes_controlbelief_regression.tex"))
```


# Are there treatment effects on attitudes?
The survey came after the experiment. Are there any treatment effect on the survey outcomes? 

The simplest is to repeat the main regression table with dummies for treatment. 
We test for joint significance of the treatment dummies.

```{r}
surv_joint_tests <- c(car::linearHypothesis(survey_regressions_list$with_treatment[[1]], 
                            c("treatmentExAntePersonal = 0",
                              "treatmentExPostPersonal = 0",
                              "treatmentExPostImpersonal = 0"))$`Pr(>Chisq)`[2],
                      car::linearHypothesis(survey_regressions_list$with_treatment[[2]], 
                            c("treatmentExAntePersonal = 0",
                              "treatmentExPostPersonal = 0",
                              "treatmentExPostImpersonal = 0"))$`Pr(>Chisq)`[2],
                      car::linearHypothesis(survey_regressions_list$with_treatment[[3]], 
                            c("treatmentExAntePersonal = 0",
                              "treatmentExPostPersonal = 0",
                              "treatmentExPostImpersonal = 0"))$`Pr(>Chisq)`[2],
                      car::linearHypothesis(survey_regressions_list$with_treatment[[4]], 
                            c("treatmentExAntePersonal = 0",
                              "treatmentExPostPersonal = 0",
                              "treatmentExPostImpersonal = 0"))$`Pr(>Chisq)`[2],
                      car::linearHypothesis(survey_regressions_list$with_treatment[[5]], 
                            c("treatmentExAntePersonal = 0",
                              "treatmentExPostPersonal = 0",
                              "treatmentExPostImpersonal = 0"))$`Pr(>Chisq)`[2])
surv_joint_tests_wrow <- tibble::tribble(~v, ~p1, ~p2, ~p3, ~p4, ~p5,
                        "Joint p-value on treatment dummies:",
                        sprintf("%4.3f", surv_joint_tests[1]),
                        sprintf("%4.3f", surv_joint_tests[2]),
                        sprintf("%4.3f", surv_joint_tests[3]),
                        sprintf("%4.3f", surv_joint_tests[4]),
                        sprintf("%4.3f", surv_joint_tests[5]))
```



```{r echo=FALSE}
t2 <- modelsummary::modelsummary(survey_regressions_list$with_treatment,
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           gof_omit = "R2 Adj.|se_type",
                           coef_map = survey_names,
                           add_rows = surv_joint_tests_wrow,
                           output = "gt") |>
  tab_spanner(label = "Fairness of Talent,Effort,Luck determining income", columns = 2:6)
t2
t2 |> as_latex() |>
    cat(file=here::here("tables","attitudes_controlbelief_regression_withT.tex"))
```


We test for joint significance of the treatment
effects for each of the 6 outcomes.
```{r}
A1 <- lm(luck_fair ~ treatment, data = mmtalent)
A1w <- car::linearHypothesis(A1, c("treatmentExAntePersonal = 0",
                          "treatmentExPostPersonal = 0",
                          "treatmentExPostImpersonal = 0"))
A2 <- lm(talent_fair ~ treatment, data = mmtalent)
A2w <- car::linearHypothesis(A2, c("treatmentExAntePersonal = 0",
                          "treatmentExPostPersonal = 0",
                          "treatmentExPostImpersonal = 0"))
A3 <- lm(effort_fair ~ treatment, data = mmtalent)
A3w <- car::linearHypothesis(A3, c("treatmentExAntePersonal = 0",
                          "treatmentExPostPersonal = 0",
                          "treatmentExPostImpersonal = 0"))
B1 <- lm(luck_control ~ treatment, data = mmtalent)
B1w <- car::linearHypothesis(B1, c("treatmentExAntePersonal = 0",
                          "treatmentExPostPersonal = 0",
                          "treatmentExPostImpersonal = 0"))
B2 <- lm(talent_control ~ treatment, data = mmtalent)
B2w <- car::linearHypothesis(B2, c("treatmentExAntePersonal = 0",
                          "treatmentExPostPersonal = 0",
                          "treatmentExPostImpersonal = 0"))
B3 <- lm(effort_control ~ treatment, data = mmtalent)
B3w <- car::linearHypothesis(B3, c("treatmentExAntePersonal = 0",
                          "treatmentExPostPersonal = 0",
                          "treatmentExPostImpersonal = 0"))

wrow <- tibble::tribble(~v, ~p1, ~p2, ~p3, ~p4, ~p5, ~p6,
                        "Joint p-value on treatment dummies:", 
          sprintf("%4.3f", A1w$`Pr(>F)`[2]),
          sprintf("%4.3f", A2w$`Pr(>F)`[2]),
          sprintf("%4.3f", A3w$`Pr(>F)`[2]),
          sprintf("%4.3f", B1w$`Pr(>F)`[2]),
          sprintf("%4.3f", B2w$`Pr(>F)`[2]),
          sprintf("%4.3f", B3w$`Pr(>F)`[2]))

modelsummary::modelsummary(list("A.luck"=A1, "A.talent"=A2, "A.effort"=A3, "B.luck"=B1, "B.talent"=B2, "B.effort"=B3),
                           stars = c('*'=0.1, '**'=0.05, '***'=0.01),
                           gof_omit = "R2 Adj.|AIC|BIC|Log.Lik.|F",
                           output="gt",
                           add_rows = wrow) |> 
  gt::tab_spanner(label="Unfair inequality", columns=2:4) |>
  gt::tab_spanner(label="Belief about individual control", columns = 5:7)
```

We see that 3 out of 18 treatment effects are significant at the 10% level, which is not surprising
even under the null of no true effect.
